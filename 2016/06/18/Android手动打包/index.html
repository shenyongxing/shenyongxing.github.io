<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="个人博客"><title>Android手动打包 | Where there is a will, there is a way!</title><link rel="stylesheet" type="text/css" href="//fonts.css.network/css?family=Source+Code+Pro"><link rel="stylesheet" type="text/css" href="/css/style.css?v=1.3.0"><link rel="stylesheet" type="text/css" href="/css/highlight.css?v=1.3.0"><link rel="Shortcut Icon" href="/favicon.ico"><link rel="bookmark" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Android手动打包</h1><a id="logo" href="/.">Where there is a will, there is a way!</a><p class="description"></p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div id="layout" class="layout-g"><div class="layout-l"><div class="content_container"><div class="post"><h1 class="post-title">Android手动打包</h1><div class="post-meta">Jun 18, 2016<span> | </span><span class="category"><a href="/categories/Android/">Android</a></span><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> Hits</span></span></div><div class="post-content"><h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>在日常开发过程中，我们经常需要打包。现在的开发平台都已经集成了打包的功能或插件，可以很容易的打包。但是我们并不清楚其中的具体原理和过程，所以有必要理解打包的过程，以便加强对安卓应用的认识和理解。<br>手动打包主要是利用安卓提供的aapt工具和jdk命令，将资源压缩的成一个apk文件的过程。aapt工具在android-sdk/build-tools/相应版本/目录下面。为了方便，可以将该路径添加到环境变量里面。<br>通过aapt工具打包，主要经过以下几个过程：<br>首先利用android studio创建一个演示项目HelloWrold。该项目仅包括一个MainActivity.java及其它一些资源文件。</p>
<h2 id="1、利用aapt命令生成R-java文件"><a href="#1、利用aapt命令生成R-java文件" class="headerlink" title="1、利用aapt命令生成R.java文件"></a>1、利用aapt命令生成R.java文件</h2><p>我们知道，android程序中是通过资源索引文件来找到资源文件的。所以我们首先必须生成R文件。而R文件则是通过aapt(Android Asset Package Tool)命令生成的。aapt的命令内容非常丰富，其中aapt打包相关命令如下：</p>
<p><img src="http://img.blog.csdn.net/20160312153651473" alt="图1"></p>
<center>图1 aapt打包命令</center><br>根据aapt的命令说明，利用如下命令产生R.java文件<br><br><img src="http://img.blog.csdn.net/20160312153803911" alt="图2"><br><br><center>图2 生成R文件</center><br>其中，-f 使强制覆盖已有文件，-m 使在-J所指定的目录下以包名创建文件夹，-S 指定资源所在的路径，有多个资源目录可以使用多个-S参数，-M 指定AndroidManifest.xml文件路径，-I 指定android.jar系统文件。需要注意的是，R文件所指定的存放位置gen是需要手动创建的，否则会报Unable to open class file R.java : No such file or directory 错误。<br>成功运行命令后，在项目根目录的gen目录下，已经成功创建了R文件，如下图：<br><br><img src="http://img.blog.csdn.net/20160312153911976" alt="图3"><br><br><center>图3 R文件</center><br>## 2、利用javac命令生成class文件<br>使用如下命令，将java源文件编译成class文件<br><br><img src="http://img.blog.csdn.net/20160312154038837" alt="图4"><br><br><center>图4 编译java文件</center><br>其中，-bootclasspath指定编译需要的系统类文件，-d 指定编译后class文件存放位置。需要注意的是，同gen目录一样，bin目录也需要手动创建。<br>成功运行后，可以看到java文件已经被编译为class文件，如下图：<br><br><img src="http://img.blog.csdn.net/20160312154134022" alt="图5"><br><br><center>图5 生成class文件</center><br>## 3、将class文件打成jar包<br>生成class文件后，使用如下命令将class文件打成jar包：<br><br><img src="http://img.blog.csdn.net/20160312154254445" alt="图6"><br><br><center>图6 将class文件打成jar包</center><br>成功执行后，就可以在bin目录下看到helloworld.jar文件，如下图：<br><br><img src="http://img.blog.csdn.net/20160312154359278" alt="图7"><br><br><center>图7 生成的jar文件</center><br>## 4、生成dex文件<br>生成了jar文件后，需要将其转化为android虚拟机可以识别的dex文件。利用如下命令将jar转化为dex文件：<br><br><img src="http://img.blog.csdn.net/20160312154523665" alt="图8"><br><br><center>图8 生成dex文件</center><br>成功运行后会在bin目录生成classes.dex文件。<br><br><img src="http://img.blog.csdn.net/20160312154710323" alt="图9"><br><br><center>图9 dex文件</center><br>在此过程中需要注意的是，如果之前的jdk版本过高，可能会出现Dx bad class file magic (cafebabe) or version (0033.0000)错误。<br>## 5、将资源打包<br>生成apk之前，还需要将资源都整合到一个文件里。例用如下的aapt命令将资源打包：<br><br><img src="http://img.blog.csdn.net/20160312154846019" alt="图10"><br><br><center>图10 打包资源</center><br>其中resource.ap<em>为指定的打包后文件名。成功运行后，在bin目录下就可以看到resource.ap</em>文件。<br>## 6、生成未签名apk文件<br>最后将dex文件和资源文件生成apk文件，使用如下命令：<br><br><img src="http://img.blog.csdn.net/20160312155021261" alt="图11"><br><br><center>图11 生成未签名apk</center><br>其中com.android.sdklib.build.ApkBuilderMain是sdklib.jar文件中的类文件。-v -u -z均是ApkBuilderMain的参数。在项目目录下，可以看到已经生成了相应的apk文件了。此时，该apk文件是未经过签名的。所以该程序是无法在设备上安装并运行的。尝试安装该未签名的apk文件时会报没有认证的错误。<br>## 7、手动为apk签名<br>首先，利用keytool工具生成私钥，如图：<br><br><img src="http://img.blog.csdn.net/20160312162315971" alt="图12"><br><br><center>图12 通过keytool生成私钥</center><br>在运行keytool后，系统会要求输入一连串的相关信息来创建私钥，如上图。最后会在制定的目录产生相应的<em>*</em>.keystore文件。<br><br>有了keystore文件，便可以对apk进行签名了。用如下命令完成对apk的签名：<br><br><img src="http://img.blog.csdn.net/20160312162552881" alt="这里写图片描述"><br><br><center>图13 对apk进行签名</center><br>完成了对apk的签名后，可以利用如下命令对其是否签名进行验证：<br><br><img src="http://img.blog.csdn.net/20160312155613107" alt="图14"><br><br><center>图14 验证签名</center><br>该命令会输出相关已认证信息和证书有效时间警告。<br>## 8、优化apk文件<br>最后对已经签名的apk文件进行zipaligin优化，如下：<br><br><img src="http://img.blog.csdn.net/20160312155740764" alt="图15"><br><br><center>图15 对apk进行align优化</center><br>从图中可以看到，该命令对apk进行了压缩和优化。最后，将生成的apk文件安装到设备。如下图<br><br><img src="http://img.blog.csdn.net/20160312162828854" alt="这里写图片描述"><br><br><center>图16 运行已签名和优化过的apk</center><br>以上即是打包的主要流程。摘取一张谷歌官网的打包流程图概括整个流程，如下：<br><br><img src="http://img.blog.csdn.net/20160312155949937" alt="图17"><br><br><center>图17 打包流程</center>

<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>1.打包的主要过程为，将生成的R文件，dex文件，资源文件，整体打包成apk安装文件，最后再签名和优化。<br>2.手工打包时需要特别注意各个工具的版本问题。例如android-19版本的aapt无法识别mipmap-xxxdpi文件夹。<br>3.此次只利用较简单的项目实践。尝试加入library时打包还未成功，还有一些问题需要克服。</p>
</div><div class="tags"><a href="/tags/Android/">Android</a><a href="/tags/打包/">打包</a></div><div class="post-nav"><a href="/2016/06/14/Android数据库升级总结/" class="next">Android数据库升级总结</a></div><div id="comments"></div></div></div></div><div class="layout-r"><div id="sidebar"><div class="widget"><div id="search-form"><div id="result-mask" class="hide"></div><label><input id="search-key" type="text" autocomplete="off" placeholder="请输入关键字..."/></label><div id="result-wrap" class="hide"><div id="search-result"></div></div><div class="hide"><template id="search-tpl"><div class="item"><a href="/{path}" title="{title}"><div class="title">{title}</div><div class="time">{date}</div><div class="tags">{tags}</div></a></div></template></div></div></div><div class="widget"><div class="widget-title"><i class="fa fa-gui"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Android/">Android</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/C/">C</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Excel/">Excel</a><span class="category-list-count">1</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-biao"> 标签</i></div><div class="tagcloud"><a href="/tags/Android/" style="font-size: 15px;">Android</a> <a href="/tags/数据库升级/" style="font-size: 15px;">数据库升级</a> <a href="/tags/打包/" style="font-size: 15px;">打包</a> <a href="/tags/算法/" style="font-size: 15px;">算法</a> <a href="/tags/排序/" style="font-size: 15px;">排序</a> <a href="/tags/ImageView/" style="font-size: 15px;">ImageView</a> <a href="/tags/ScaleType/" style="font-size: 15px;">ScaleType</a> <a href="/tags/Excel/" style="font-size: 15px;">Excel</a> <a href="/tags/Android多语言/" style="font-size: 15px;">Android多语言</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-fei"> 归档</i></div><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/06/">六月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/10/">十月 2015</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-xie"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2016/06/18/Android手动打包/">Android手动打包</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/06/14/Android数据库升级总结/">Android数据库升级总结</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/06/12/基础排序算法/">基础排序算法</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/06/12/ImageView的src与background属性的区别/">ImageView的src与background属性的区别</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/10/16/Excel常用文本操作/">Excel常用文本操作</a></li></ul></div></div></div></div><a id="totop" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=1.3.0" async></script><div id="footer"><div class="footer-info"><p><a href="/baidusitemap.xml">网站地图</a> |<a href="/atom.xml">订阅本站</a> |<span>联系博主：<a href="mailto:null" target="_blank" class="fa fa-email"> </a><a href="null" target="_blank" class="fa fa-weibo"></a><a href="null" target="_blank" class="fa fa-github"> </a></span></p><p><span> Copyright &copy;<a href="/." rel="nofollow">夏天</a></span><span> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a></span><span><a rel="nofollow" target="_blank" href="https://github.com/chaooo/hexo-theme-BlueLake"> Theme </a>by<a rel="nofollow" target="_blank" href="https://github.com/chaooo"> Charles.</a></span></p></div></div></div><script type="text/javascript" src="/js/search.json.js?v=1.3.0"></script></body></html>